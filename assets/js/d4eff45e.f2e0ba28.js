(self.webpackChunkkubevela_io=self.webpackChunkkubevela_io||[]).push([[87959],{3905:function(e,a,t){"use strict";t.d(a,{Zo:function(){return p},kt:function(){return d}});var n=t(67294);function l(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){l(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function r(e,a){if(null==e)return{};var t,n,l=function(e,a){if(null==e)return{};var t,n,l={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(l[t]=e[t]);return l}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var u=n.createContext({}),s=function(e){var a=n.useContext(u),t=a;return e&&(t="function"==typeof e?e(a):o(o({},a),e)),t},p=function(e){var a=s(e.components);return n.createElement(u.Provider,{value:a},e.children)},m={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},c=n.forwardRef((function(e,a){var t=e.components,l=e.mdxType,i=e.originalType,u=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),c=s(t),d=l,k=c["".concat(u,".").concat(d)]||c[d]||m[d]||i;return t?n.createElement(k,o(o({ref:a},p),{},{components:t})):n.createElement(k,o({ref:a},p))}));function d(e,a){var t=arguments,l=a&&a.mdxType;if("string"==typeof e||l){var i=t.length,o=new Array(i);o[0]=c;var r={};for(var u in a)hasOwnProperty.call(a,u)&&(r[u]=a[u]);r.originalType=e,r.mdxType="string"==typeof e?e:l,o[1]=r;for(var s=2;s<i;s++)o[s]=t[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}c.displayName="MDXCreateElement"},81168:function(e,a,t){"use strict";t.r(a),t.d(a,{frontMatter:function(){return o},metadata:function(){return r},toc:function(){return u},default:function(){return p}});var n=t(22122),l=t(19756),i=(t(67294),t(3905)),o={title:"China Merchants Bank's Practice on Offline Installation with KubeVela",author:"Xiangbo Ma",author_title:"(Cloud platform development team)",author_url:"http://www.cmbchina.com/",author_image_url:"/img/china-merchants-bank.jpg",tags:["KubeVela"],description:"",image:"https://raw.githubusercontent.com/oam-dev/KubeVela.io/main/docs/resources/KubeVela-03.png",hide_table_of_contents:!1},r={permalink:"/blog/2022/04/01/offline-deployment-practice copy",editUrl:"https://github.com/oam-dev/kubevela.io/tree/main/blog/2022-04-01-offline-deployment-practice copy.md",source:"@site/blog/2022-04-01-offline-deployment-practice copy.md",title:"China Merchants Bank's Practice on Offline Installation with KubeVela",description:"",date:"2022-04-01T00:00:00.000Z",formattedDate:"April 1, 2022",tags:[{label:"KubeVela",permalink:"/blog/tags/kube-vela"}],readingTime:5.34,truncated:!1,prevItem:{title:"Easily Manage your Application Shipment With Differentiated Configuration in Multi-Cluster",permalink:"/blog/2022/04/06/multi-cluster-management"},nextItem:{title:"Machine Learning Practice with KubeVela",permalink:"/blog/2022/03/02/kubevela-with-machine-learning"}},u=[{value:"KubeVela Offline Installation Solution",id:"kubevela-offline-installation-solution",children:[{value:"Vela CLI Offline Installation",id:"vela-cli-offline-installation",children:[]},{value:"Vela Core Offline Installation",id:"vela-core-offline-installation",children:[]},{value:"Addon Offline Installation",id:"addon-offline-installation",children:[]}]},{value:"Summarize",id:"summarize",children:[]}],s={toc:u};function p(e){var a=e.components,t=(0,l.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,n.Z)({},s,t,{components:a,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The cloud platform development team of China Merchants Bank has been trying out KubeVela since 2021 internally and aims to using it for enhancing our primary application delivery and management capabilities. Due to the specific security concern for financial insurance industry, network control measurements are relatively strict, and our intranet cannot directly pull Docker Hub image, and there is no Helm image source available as well. Therefore, in order to landing KubeVela in the intranet, you must perform a complete offline installation."),(0,i.kt)("p",null,"This article will take the KubeVela V1.2.5 version as an example, introduce the offline installation practice to help other users easier to complete KubeVela's deployment in offline environment."),(0,i.kt)("h2",{id:"kubevela-offline-installation-solution"},"KubeVela Offline Installation Solution"),(0,i.kt)("p",null,"We divide the offline installation of KubeVela in three parts, which are Vela CLI, Vela Core, and Addon offline installation. Each part mainly involves the loading of the relevant Docker image and Helm's package, which can greatly speed up deployment process in offline environment."),(0,i.kt)("p",null,"Before doing so, please ensure that Kubernetes cluster version is  ",(0,i.kt)("inlineCode",{parentName:"p"},">= v1.19 && < v1.22"),". One way of KubeVela as a control plane relies on Kubernetes, which can be placed in any product or in any cloud provider. At the same time, you can also use Kind or Minikube to deploy KubeVela locally."),(0,i.kt)("h3",{id:"vela-cli-offline-installation"},"Vela CLI Offline Installation"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"First, you need to download of the binary version of ",(0,i.kt)("inlineCode",{parentName:"li"},"vela")," that you want by checking KubeVela ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/oam-dev/kubevela/releases"},"Release Log")),(0,i.kt)("li",{parentName:"ul"},"Unzip binary files and configure the appropriate environment variables in ",(0,i.kt)("inlineCode",{parentName:"li"},"$PATH"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Unzip binary file",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"tar -zxvf vela-v1.2.5-linux-amd64.tar.gz")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"mv ./linux-amd64/vela /usr/local/bin/vela")))),(0,i.kt)("li",{parentName:"ul"},"Set environment variables",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"vi /etc/profile")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},'export PATH="$PATH:/usr/local/bin"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"source /etc/profile")))),(0,i.kt)("li",{parentName:"ul"},"Verify the installation of Vela CLI through ",(0,i.kt)("inlineCode",{parentName:"li"},"vela version"))))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"CLI VERSION: V1.2.5\nCore Version:\nGitRevision: git-ef80b66\nGOLANGVERSION: Go1.17.7\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At this point, Vela CLI has been deployed offline!")),(0,i.kt)("h3",{id:"vela-core-offline-installation"},"Vela Core Offline Installation"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Before deploying Vela Core offline, first you need to install ",(0,i.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"Helm")," in an offline environment and its version needs to meet ",(0,i.kt)("inlineCode",{parentName:"li"},"v3.2.0+")),(0,i.kt)("li",{parentName:"ul"},"Prepare Docker image. Vela Core's deployment mainly involves 5 images, you need to first visit the Docker Hub in extranet to download the corresponding images, then load them to offline environment",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Pull the image from Docker Hub",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/vela-core:v1.2.5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/cluster-gateway:v1.1.7")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/kube-webhook-certgen:v2.3")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/alpine-k8s:1.18.2")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/hello-world:v1")))),(0,i.kt)("li",{parentName:"ul"},"Save image to local disks",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o vela-core.tar oamdev/vela-core:v1.2.5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o cluster-gateway.tar oamdev/cluster-gateway:v1.1.7")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o kube-webhook-certgen.tar oamdev/kube-webhook-certgen:v2.3")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o alpine-k8s.tar oamdev/alpine-k8s:1.18.2")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o hello-world.tar oamdev/hello-world:v1")))),(0,i.kt)("li",{parentName:"ul"},"Re-load the image in the offline environment",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load vela-core.tar")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load cluster-gateway.tar")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load kube-webhook-certgen.tar")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load alpine-k8s.tar")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load hello-world.tar")))))),(0,i.kt)("li",{parentName:"ul"},"Download ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/oam-dev/KubeVela/releases"},"KubeVela Core"),", copy it to offline environment and use Helm to repackage",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Repackage the KubeVela source code and install the chart package to the control cluster offline",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"helm package kubevela/charts/vela-core --destination kubevela/charts")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"helm install --create-namespace -n vela-system kubevela kubevela/charts/vela-core-0.1.0.tgz --wait")))),(0,i.kt)("li",{parentName:"ul"},"Check the output")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"KubeVela Control Plane Has Been successfully set up on your cluster.\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At this point, Vela Core has been deployed offline!")),(0,i.kt)("h3",{id:"addon-offline-installation"},"Addon Offline Installation"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"First download ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/oam-dev/catalog"},"Catalog Source")," and copy it to offline environment"),(0,i.kt)("li",{parentName:"ul"},"Here, we will take VelaUX, one of many more addons, as an example. First prepare its Docker image, VelaUX mainly involve 2 images, you need to first access the extranet to download the corresponding image from Docker Hub, then load it to offline environment",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Pull the image from Docker Hub",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/vela-apiserver:v1.2.5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker pull oamdev/velaux:v1.2.5")))),(0,i.kt)("li",{parentName:"ul"},"Save image to local disks",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o vela-apiserver.tar oamdev/vela-apiserver:v1.2.5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker save -o velaux.tar oamdev/velaux:v1.2.5")))),(0,i.kt)("li",{parentName:"ul"},"Re-load the image in the offline environment",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load vela-apiserver.tar")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"docker load velaux.tar")))))),(0,i.kt)("li",{parentName:"ul"},"Install VelaUX",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Install VelaUX via Vela CLI",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"vela addon enable catalog-master/addons/velaux")))),(0,i.kt)("li",{parentName:"ul"},"Check the output")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"  Addon: velaux enabled Successfully.\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If there is a cluster installed route Controller or Nginx Ingress Controller and also linked with an available domain, you can deploy external routing to make VelaUX accessible. Here present Openshift Route as an example, you can also choose Ingress if you wish")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: route.openshift.io/v1\nkind: Route\nmetadata:\nname: velaux-route\nnamespace: vela-system\nspec:\nhost: velaux.xxx.xxx.cn\nport:\n  targetPort: 80\nto:\n  kind: Service\n  name: velaux\n  weight: 100\nwildcardPolicy: None\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Check the installation")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"curl -I -m 10 -o /dev/null -s -w %{http_code} http://velaux.xxx.xxx.cn/applications\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"At this point, VelaUX has been deployed offline! At the same time, for other types of Addon's offline deployment, access to the corresponding directory of the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/oam-dev/catalog"},"Catalog Source")," and repeat the above moves, you would complete all the addons' offline deployments for good.")),(0,i.kt)("h2",{id:"summarize"},"Summarize"),(0,i.kt)("p",null,"During offline deployment, we also try to save Vela Core and Addon's resource that generated to be YAML files after deploying in extranet and re-deploy them in an offline environment, but because of all different kinds of resource involved in and it requires many other authorization issues to resolve, this way is more than cumbersome."),(0,i.kt)("p",null,"With this practice of KubeVela's offline deployment, we hope it help you build a complete set of KubeVela in offline environment much faster. Offline installation is pretty much a pain point for most developers, we also see that the KubeVela community is introducing the brand new ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/oam-dev/velad"},"velad"),", a fully offline, highly accountable installation tool. Velad can help automate completion by making many steps as one, such as preparing clusters, downloading and packing image, installing and etc. Further more, it do support many features: In Linux machine (such as Alibaba Cloud ECS) we can locally spin up a cluster to install Vela-Core; while starting a KubeVela control plane, do not have to worry about its data to be lost when machine behind it accidentally was shutdown; Velad can stores all the data from control plane cluster into a traditional database (such as MySQL deployed on another ECS)."),(0,i.kt)("p",null,"In the recent version to come, China Merchants Bank will increase the efforts in the open source community of KubeVela, actively building: enterprise-level capacity, enhancement on multi-cluster, offline deployment and application-level observability. We'll also be contributing the financial industry's user scenarios and business needs, driving cloud-native ecology achieve more easily and efficient application management experience, and at last but not at least, welcome you the community member to join us together in this journey."))}p.isMDXComponent=!0}}]);